<!DOCTYPE html>
<html>
<head>
    <title>CORE Mainframe</title>
    <style>
        html, body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        #navigation {
            width: 100vw;
            height: 100vh;
            border: none;
        }
    </style>
</head>
<body>

<div id="iframe"></div>

<div style="position: absolute" id="loaded-plugin"></div>

<script>
    const plugins = {
        "webuntis": {
            url: "webuntis.html",
            permissions: ["webuntis"]
        },
        "sokrates": {
            url: "sokrates.html",
            permissions: ["webuntis", "sokrates"]
        },
        "login": {
            url: "http://localhost:4200/login",
            permissions: ["login"]
        }
    };

    let loggedIn = false;
    fetch('https://localhost:7139/Auth/IsAuthed', {
        method: 'GET',
        credentials: "include"
    }).then(response => response.json())
        .then(data => loggedIn = data === true).catch(err => loggedIn = false).then(() => {
        const newIframe = document.createElement("iframe");
        if(loggedIn) {
            newIframe.src = 'navigation.html';
            newIframe.id = "navigation";
        } else {
            newIframe.src = plugins["login"].url;
            newIframe.id = "navigation";
            newIframe.style.width = "90%";
            newIframe.style.height = "90vh";
        }
        iframe.appendChild(newIframe);
    })
        .then(()=>{
            const navigation = document.getElementById('navigation');
            const plugin = document.getElementById("loaded-plugin");
            let pluginIframe = null;
            let loadedPlugin = null;

            window.addEventListener("message", event => {
                console.debug("message", event.data, event.source)

                if (event.source === navigation.contentWindow) {
                    if (typeof event.data.method !== "string") {
                        console.error("Invalid message from navigation", event);
                        return;
                    }

                    switch (event.data.method) {
                        case "loadPlugin":
                            const loadPlugin = event.data.plugin;
                            if (typeof loadPlugin !== "string") {
                                console.error("Invalid message from navigation", event);
                                return;
                            }
                            plugin.innerHTML = '';

                            if (Object.keys(plugins).includes(loadPlugin)) {
                                console.log("loading plugin", loadPlugin);
                                loadedPlugin = plugins[loadPlugin];

                                pluginIframe = document.createElement('iframe');
                                pluginIframe.src = loadedPlugin.url;
                                pluginIframe.style.width = "100%";
                                pluginIframe.style.height = "100%";
                                pluginIframe.style.border = "none";
                                plugin.appendChild(pluginIframe);
                            } else {
                                console.error("Illegal plugin", loadPlugin);
                            }
                            break;
                        case "container":
                            if (typeof event.data.x !== "number" || typeof event.data.y !== "number" || typeof event.data.width !== "number" || typeof event.data.height !== "number") {
                                console.error("Invalid message from navigation", event);
                                return;
                            }

                            plugin.style.left = event.data.x + "px";
                            plugin.style.top = event.data.y + "px";
                            plugin.style.width = event.data.width + "px";
                            plugin.style.height = event.data.height + "px";
                            break;
                    }
                }

                if (event.source === pluginIframe?.contentWindow) {

                    switch (event.data.method) {
                        case "login":
                            console.log(event.data.data)

                            fetch('https://localhost:7139/Auth/Login', {
                                method: 'POST',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json',
                                },
                                credentials: "include",
                                body: JSON.stringify({
                                    "username": event.data.data.username,
                                    "password": event.data.data.password
                                }),
                            });

                            return;
                        case "msg":
                            if (event.data.data === "webuntis") {
                                if (loadedPlugin.permissions.includes("webuntis"))
                                    pluginIframe?.contentWindow.postMessage("webuntis data");
                                else
                                    console.error("Plugin does not have permission to access webuntis data");
                            }

                            if (event.data.data === "sokrates") {
                                if (loadedPlugin.permissions.includes("sokrates"))
                                    pluginIframe?.contentWindow.postMessage("sokrates data");
                                else
                                    console.error("Plugin does not have permission to access sokrates data");
                            }

                            if (event.data.data === "login") {
                                if (loadedPlugin.permissions.includes("login"))
                                    pluginIframe?.contentWindow.postMessage("login data");
                                else
                                    console.error("Plugin does not have permission to access sokrates data");
                            }
                            break;
                    }
                }
            })
        });

</script>

</body>
</html>
